rules_version = '2';

// -----------------------------
// üîê Helper Functions
// -----------------------------

function isSignedIn() {
  return request.auth != null && request.auth.token.email != null;
}

function isAdmin() {
  return request.auth != null &&
    request.auth.token.email in [
      "mohitkmr8566@gmail.com",
      "warea.admin@gmail.com"
    ];
}

function isOwner(emailField) {
  return isSignedIn() && emailField == request.auth.token.email;
}

// -----------------------------
// ‚úÖ Order Data Validation
// -----------------------------
function isValidOrder() {
  return request.resource.data.keys().hasAll([
      'userId', 'customer', 'items', 'total', 'status', 'createdAt', 'payment'
    ]) &&
    isOwner(request.resource.data.userId) &&
    (request.resource.data.items is list) &&
    (request.resource.data.items.size() > 0) &&
    request.resource.data.items[0].keys().hasAll(['id','name','price','qty']) &&
    (request.resource.data.items[0].price is number) &&
    (request.resource.data.items[0].qty is number) &&
    (request.resource.data.total is number) &&
    (
      (request.resource.data.payment.type == 'COD') ||
      (
        request.resource.data.payment.type == 'SAVED_CARD' &&
        request.resource.data.payment.keys().hasAll(['type','methodId','card','name'])
      )
    );
}

// -----------------------------
// ‚úÖ Review Validation
// -----------------------------
function isValidReview() {
  return request.resource.data.keys().hasAll(['userId', 'rating', 'comment', 'createdAt']) &&
    isOwner(request.resource.data.userId) &&
    (request.resource.data.rating is number) &&
    (request.resource.data.rating >= 1 && request.resource.data.rating <= 5) &&
    (request.resource.data.comment is string);
}

// -----------------------------
// üîí MAIN RULES
// -----------------------------
service cloud.firestore {
  match /databases/{database}/documents {

    /* --------------------------- PRODUCTS --------------------------- */
    match /products/{productId} {
      // Public read access for product listings and PDP
      allow read: if true;

      // Admins only can write / update / delete products
      allow write: if isAdmin();

      // Product reviews (nested)
      match /reviews/{reviewId} {
        allow read: if true;
        allow create: if isSignedIn() && isValidReview();

        // Admin moderation or user flagging
        allow update: if
          isAdmin()
          ||
          (
            isSignedIn() &&
            request.resource.data.flagged == true &&
            (request.resource.data.flags is number) &&
            (
              !('flags' in resource.data) ||
              request.resource.data.flags >= resource.data.flags + 1
            ) &&
            request.resource.data.comment == resource.data.comment &&
            request.resource.data.rating == resource.data.rating &&
            request.resource.data.userId == resource.data.userId &&
            request.writeFields.hasOnly(['flagged','flags'])
          );

        // Allow review deletion (user‚Äôs own or admin)
        allow delete: if isSignedIn() && isOwner(resource.data.userId);
        allow delete: if isAdmin();
      }
    }

    /* --------------------------- GLOBAL REVIEWS (collectionGroup) --------------------------- */
    match /{anyPath=**}/reviews/{reviewId} {
      allow read: if true;
      allow create: if isSignedIn() && isValidReview();
      allow update: if
        isAdmin()
        ||
        (
          isSignedIn() &&
          request.resource.data.flagged == true &&
          (request.resource.data.flags is number) &&
          (
            !('flags' in resource.data) ||
            request.resource.data.flags >= resource.data.flags + 1
          ) &&
          request.resource.data.comment == resource.data.comment &&
          request.resource.data.rating == resource.data.rating &&
          request.resource.data.userId == resource.data.userId &&
          request.writeFields.hasOnly(['flagged','flags'])
        );
      allow delete: if isSignedIn() && isOwner(resource.data.userId);
      allow delete: if isAdmin();
    }

    /* --------------------------- HERO SLIDES --------------------------- */
    match /heroSlides/{slideId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /* --------------------------- ORDERS --------------------------- */
    match /orders/{orderId} {
      // ‚úÖ Admins or order owners can read
      allow read: if isAdmin() || (isSignedIn() && isOwner(resource.data.userId));

      // ‚úÖ Users can create their own orders
      allow create: if isValidOrder();

      // ‚úÖ Admins can update order status (e.g., shipped, delivered, cancelled)
      allow update: if isAdmin();

      // ‚ùå Nobody (not even admin) should delete orders directly
      allow delete: if false;

      /* ---------------- REPLACEMENTS (SUBCOLLECTION) ---------------- */
      match /replacements/{replaceId} {
        // Admin or order owner can read
        allow read: if isAdmin()
                    || (isSignedIn() && isOwner(resource.data.userId));

        // User can request replacement for their order
        allow create: if isSignedIn()
                      && isOwner(resource.data.userId)
                      && request.resource.data.keys().hasAll(['reason', 'status', 'createdAt', 'userId'])
                      && request.resource.data.userId == request.auth.token.email;

        // Only admin can approve / reject replacements
        allow update: if isAdmin();

        // Only admin can delete replacements
        allow delete: if isAdmin();
      }
    }

    /* --------------------------- USERS --------------------------- */
    match /users/{userEmail} {
      allow read, create, update: if isOwner(userEmail);

      match /addresses/{addrId} {
        allow read, list, create, update, delete: if isOwner(userEmail);
      }

      match /paymentMethods/{pmId} {
        allow read, list, create, update, delete: if isOwner(userEmail);
      }

      match /notifications/{notifId} {
        allow read, list: if isOwner(userEmail);
        allow create, update: if isOwner(userEmail);
        allow delete: if false;
      }
    }
  }
}
